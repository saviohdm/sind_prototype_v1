<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SIND • Visualizar Procedimento (Vanilla)</title>
  <style>
    :root{
      --bg: #f9fafb;            /* cinza claro */
      --text: #1f2937;          /* cinza-escuro */
      --muted: #6b7280;         /* cinza */
      --muted-2:#9ca3af;
      --white:#ffffff;
      --red-900:#7f1d1d;
      --red-800:#991b1b;
      --red-700:#b91c1c;
      --red-50:#fef2f2;
      --border:#e5e7eb;
      --card:#ffffff;
      --green:#16a34a;
      --amber:#d97706;
      --blue:#1d4ed8;
      --red:#dc2626;
      --shadow: 0 10px 20px rgba(0,0,0,.04), 0 2px 6px rgba(0,0,0,.06);
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background:var(--bg); color:var(--text);
    }
    a{ color:var(--red-700); text-decoration:none }
    a:hover{ text-decoration:underline }

    /* Layout */
    .layout{ display:grid; grid-template-columns:260px 1fr; min-height:100dvh }

    /* Sidebar */
    aside{ background:var(--red-900); color:var(--white); padding:24px 16px; }
    .brand{ display:flex; align-items:center; gap:12px; margin-bottom:18px }
    .brand span{ font-weight:800; letter-spacing:.5px }
    nav{ display:flex; flex-direction:column; gap:8px }
    .nav-item{ display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; color:#fff }
    .nav-item:hover{ background:rgba(255,255,255,.08) }
    .nav-item--active{ background:rgba(255,255,255,.12) }
    .nav-item svg{ width:16px; height:16px }

    /* Main */
    main{ padding:24px; }
    .header{ display:flex; align-items:flex-end; justify-content:space-between; gap:16px; margin-bottom:16px }
    .title{ margin:0; font-size:22px; font-weight:800; color:#111827 }
    .title-group{ display:flex; flex-direction:column; gap:8px }
    .tags{ display:flex; flex-wrap:wrap; gap:8px }
    .badge{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700; border:1px solid var(--border); background:#fff }
    .badge--ramo{ background:#fff }
    .badge--sigilo{ background:#fff }
    .status--andamento{ background:#eef2ff; color:var(--blue); border-color:#e5e7eb }
    .status--suspenso{ background:#fffbeb; color:var(--amber); border-color:#fef3c7 }
    .status--finalizado{ background:#ecfdf5; color:var(--green); border-color:#d1fae5 }

    .row-actions{ display:flex; align-items:center; gap:10px }

    /* Buttons */
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px; font-weight:600; border:1px solid transparent;
      padding:10px 18px; border-radius:14px; cursor:pointer;
      transition: background .2s, border-color .2s, color .2s, transform .02s;
      background:var(--red-700); color:var(--white); box-shadow:var(--shadow);
    }
    .btn:hover{ background:var(--red-800) }
    .btn:active{ transform:translateY(1px) }
    .btn--outline{ background:#fff; color:var(--red-700); border-color:var(--red-700); box-shadow:none }
    .btn--outline:hover{ background:var(--red-50) }
    .btn--muted{ background:#f3f4f6; color:#374151; border-color:#e5e7eb; box-shadow:none }
    .btn--sm{ padding:8px 12px; border-radius:10px; font-size:13px }

    /* Cards */
    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); margin-bottom:16px }
    .card__head{ padding:14px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:10px }
    .card__body{ padding:16px }
    .section-title{ margin:0; font-weight:700; font-size:18px; color:#374151; display:flex; align-items:center; gap:8px }

    /* Key-Value grid */
    .kv{ display:grid; grid-template-columns: 1fr 1fr; gap:12px 16px }
    .kv__item{ background:#fff; padding:6px 0 }
    .kv__key{ font-size:12px; color:var(--muted-2); margin-bottom:4px }
    .kv__val{ font-size:14px; color:#111827; font-weight:600 }

    /* Chips */
    .chip{ display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border:1px solid var(--border); background:#fff; border-radius:999px; font-size:12px }

    /* Table */
    .table{ width:100%; border-collapse:collapse }
    .table th, .table td{ text-align:left; padding:10px 12px; border-bottom:1px solid var(--border); vertical-align:top }
    .table th{ font-size:12px; color:#6b7280; font-weight:700; background:#f9fafb }
    .table td{ font-size:14px }
    .table__actions{ display:flex; align-items:center; gap:8px }

    /* Modal */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; padding:16px; z-index:50 }
    .modal.open{ display:flex }
    .dialog{ width:min(720px, 100%); background:#fff; border-radius:16px; border:1px solid var(--border); box-shadow:var(--shadow); overflow:hidden }
    .dialog__head{ padding:14px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:12px }
    .dialog__title{ font-weight:800; color:#111827; margin:0 }
    .dialog__body{ padding:16px }
    .dialog__foot{ padding:14px 16px; border-top:1px solid var(--border); display:flex; align-items:center; justify-content:flex-end; gap:10px }

    /* Form (modal) */
    .form-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:16px }
    .field{ display:flex; flex-direction:column; gap:6px }
    .label{ font-size:13px; font-weight:700; color:#374151 }
    .hint{ font-size:12px; color:var(--muted-2) }
    input[type="text"], input[type="date"], input[type="file"], select{
      width:100%; padding:10px 12px; border:1px solid var(--border);
      border-radius:12px; background:#fff; font-size:14px; color:#111827;
      outline:none;
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- Sidebar -->
    <aside>
      <div class="brand">
        <img src="/image.png" alt="CNMP" style="width:100px; height:auto" />
        <span>SIND</span>
      </div>
      <nav>
        <a class="nav-item" href="./index.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 12L12 4l8 8"/>
            <path d="M4 12v8h16v-8"/>
          </svg>
          <span>Início</span>
        </a>
        <a class="nav-item" href="novo.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="8" x2="12" y2="16"/>
            <line x1="8" y1="12" x2="16" y2="12"/>
          </svg>
          <span>Novo Procedimento</span>
        </a>
        <a class="nav-item" href="acervo.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="7" width="18" height="13" rx="2"/>
            <path d="M3 7V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v2"/>
          </svg>
          <span>Acervo</span>
        </a>
        <a class="nav-item" href="consulta.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
          </svg>
          <span>Consulta</span>
        </a>
        <a class="nav-item" href="mensagens.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="7" width="18" height="10" rx="2"/>
            <polyline points="3 7 12 13 21 7"/>
          </svg>
          <span>Mensagens</span>
        </a>
        <a class="nav-item" href="estatistica.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="12" width="4" height="8"/>
            <rect x="10" y="8" width="4" height="12"/>
            <rect x="17" y="4" width="4" height="16"/>
          </svg>
          <span>Estatísticas</span>
        </a>
      </nav>
    </aside>

    <!-- Main -->
    <main>
      <!-- Header -->
      <header class="header">
        <div class="title-group">
          <h1 class="title">Procedimento <span id="proc-numero">—</span></h1>
          <div class="tags">
            <span class="badge badge--ramo" id="tag-ramo">—</span>
            <span class="badge status--andamento" id="tag-situacao">—</span>
            <span class="badge badge--sigilo" id="tag-sigilo">—</span>
          </div>
        </div>
        <div class="row-actions">
          <button class="btn btn--outline" type="button" id="btn-voltar">Voltar</button>
          <button class="btn btn--muted" type="button" id="btn-editar" title="(placeholder)">Editar</button>
          <button class="btn" type="button" id="btn-novo-andamento">Novo andamento</button>
        </div>
      </header>

      <!-- DADOS BÁSICOS -->
      <section class="card" aria-labelledby="db-title">
        <div class="card__head">
          <h2 id="db-title" class="section-title">Dados básicos</h2>
        </div>
        <div class="card__body">
          <div class="kv" id="kv-dados-basicos">
            <!-- preenchido via JS -->
          </div>
        </div>
      </section>

      <!-- ENVOLVIDOS -->
      <section class="card" aria-labelledby="env-title">
        <div class="card__head">
          <h2 id="env-title" class="section-title">Envolvidos</h2>
        </div>
        <div class="card__body">
          <table class="table" aria-describedby="env-title">
            <thead>
              <tr>
                <th style="width:40%">Nome</th>
                <th style="width:20%">Matrícula</th>
                <th style="width:40%">CPF</th>
              </tr>
            </thead>
            <tbody id="tbody-envolvidos"><tr><td colspan="3">—</td></tr></tbody>
          </table>
        </div>
      </section>

      <!-- FATOS -->
      <section class="card" aria-labelledby="fatos-title">
        <div class="card__head">
          <h2 id="fatos-title" class="section-title">Fatos</h2>
        </div>
        <div class="card__body">
          <table class="table" aria-describedby="fatos-title">
            <thead>
              <tr>
                <th>Descrição</th>
                <th>Data do fato</th>
                <th>Data da prescrição</th>
                <th>Envolvidos vinculados</th>
              </tr>
            </thead>
            <tbody id="tbody-fatos"><tr><td colspan="4">—</td></tr></tbody>
          </table>
        </div>
      </section>

      <!-- HISTÓRICO DE ANDAMENTOS -->
      <section class="card" aria-labelledby="and-title">
        <div class="card__head">
          <h2 id="and-title" class="section-title">Histórico de andamentos</h2>
          <div class="row-actions">
            <button class="btn btn--outline btn--sm" id="btn-abrir-andamento">Incluir andamento</button>
          </div>
        </div>
        <div class="card__body">
          <table class="table" aria-describedby="and-title">
            <thead>
              <tr>
                <th style="width:120px">Data</th>
                <th>Tipo</th>
                <th style="width:220px">Anexo</th>
                <th style="width:120px">Ações</th>
              </tr>
            </thead>
            <tbody id="tbody-andamentos"><tr><td colspan="4">—</td></tr></tbody>
          </table>
        </div>
      </section>

    </main>
  </div>

  <!-- MODAL: Novo Andamento -->
  <div class="modal" id="dlg-andamento" role="dialog" aria-modal="true" aria-labelledby="dlg-andamento-title">
    <div class="dialog">
      <div class="dialog__head">
        <h3 id="dlg-andamento-title" class="dialog__title">Incluir andamento</h3>
        <button class="btn btn--muted btn--sm" type="button" id="btn-fechar-andamento">Fechar</button>
      </div>
      <div class="dialog__body">
        <div class="form-grid">
          <div class="field" style="grid-column:1 / -1">
            <label class="label" for="and-desc">Descrição do andamento</label>
            <select id="and-desc">
              <option value="">Selecione...</option>
              <option>Instauração / Conversão</option>
              <option>Celebração de Acordo</option>
              <option>Sobrestamento</option>
              <option>Admissibilidade recursal</option>
              <option>Julgamento recursal</option>
              <option>Avocação pelo CNMP</option>
              <option>Arquivamento</option>
              <option>Decisão de mérito</option>
              <option>Outras decisões</option>
              <option>Baixa definitiva</option>
              <option>Reativação do procedimento</option>
            </select>
          </div>
          <!-- Campo condicional: Nova classe (apenas quando "Instauração / Conversão" for selecionado) -->
          <div class="field" id="field-nova-classe" style="grid-column:1 / -1; display:none">
            <label class="label" for="and-nova-classe">Nova classe</label>
            <select id="and-nova-classe">
              <option value="">Selecione...</option>
              <option>Notícia de Fato</option>
              <option>Reclamação</option>
              <option>Sindicância</option>
              <option>Procedimento Preparatório</option>
              <option>Procedimento Investigatório</option>
              <option>Procedimento Administrativo Disciplinar</option>
            </select>
            <div class="hint">Selecione a nova classe do procedimento (quando aplicável).</div>
          </div>
          <div class="field">
            <label class="label" for="and-data">Data do movimento</label>
            <input id="and-data" type="date" />
          </div>
          <!-- Campo condicional: Data Fim (apenas quando "Sobrestamento" for selecionado) -->
          <div class="field" id="field-data-fim" style="display:none">
            <label class="label" for="and-data-fim">Data Fim</label>
            <input id="and-data-fim" type="date" />
          </div>
          <!-- Campo condicional: Admissibilidade recursal (apenas quando "Admissibilidade recursal" for selecionado) -->
          <div class="field" id="field-adm-recursal" style="grid-column:1 / -1; display:none">
            <span class="label">Admissibilidade recursal</span>
            <div class="row-actions" role="radiogroup" aria-label="Admissibilidade recursal" style="flex-wrap:wrap">
              <label class="chip" style="cursor:pointer">
                <input type="radio" name="and-adm" value="Recebimento" style="margin-right:6px" />
                Recebimento
              </label>
              <label class="chip" style="cursor:pointer">
                <input type="radio" name="and-adm" value="Rejeição" style="margin-right:6px" />
                Rejeição
              </label>
            </div>
          </div>
          <!-- Campo condicional: Julgamento recursal (apenas quando "Julgamento recursal" for selecionado) -->
          <div class="field" id="field-julg-recursal" style="grid-column:1 / -1; display:none">
            <span class="label">Julgamento recursal</span>
            <div class="row-actions" role="radiogroup" aria-label="Julgamento recursal" style="flex-wrap:wrap">
              <label class="chip" style="cursor:pointer">
                <input type="radio" name="and-julg" value="Procedência" style="margin-right:6px" />
                Procedência
              </label>
              <label class="chip" style="cursor:pointer">
                <input type="radio" name="and-julg" value="Parcial procedência" style="margin-right:6px" />
                Parcial procedência
              </label>
              <label class="chip" style="cursor:pointer">
                <input type="radio" name="and-julg" value="Improcedência" style="margin-right:6px" />
                Improcedência
              </label>
              <label class="chip" style="cursor:pointer">
                <input type="radio" name="and-julg" value="Extinção sem análise de mérito" style="margin-right:6px" />
                Extinção sem análise de mérito
              </label>
            </div>
          </div>
          <div class="field">
            <label class="label" for="and-arquivo">Anexo (PDF obrigatório)</label>
            <input id="and-arquivo" type="file" accept="application/pdf" />
            <div class="hint">O arquivo é obrigatório e deve ser PDF.</div>
          </div>
        </div>
      </div>
      <div class="dialog__foot">
        <button class="btn btn--outline" type="button" id="btn-cancelar-andamento">Cancelar</button>
        <button class="btn" type="button" id="btn-salvar-andamento">Salvar andamento</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- Util ----------
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const openModal = (id) => { document.body.style.overflow='hidden'; $('#'+id).classList.add('open'); };
    const closeModal = (id) => { $('#'+id).classList.remove('open'); document.body.style.overflow='auto'; };

    // ---------- Estado (mock inicial) ----------
    const state = {
      procedimento: null,
      andamentos: [],
      urlObjects: [] // para limpar URLs ao sair
    };

    // Exemplo de procedimento (mock). Em um backend real, buscaríamos por ID (querystring)
    function getProcedimentoMock(){
      return {
        ramo: 'MPBA',
        numero: '2025.000123.000045',
        classe: 'PAD - Processo Administrativo Disciplinar',
        sigilo: true,
        dataAutuacao: '2025-07-12',
        situacao: 'em andamento', // 'em andamento' | 'suspenso' | 'finalizado'
        docInicial: { nome: 'representacao-inicial.pdf', url: '#' },
        envolvidos: [
          { nome:'Maria Souza', matricula:'A1234', cpf:'123.456.789-00' },
          { nome:'João Silva', matricula:'B8790', cpf:'987.654.321-00' }
        ],
        fatos: [
          { descricao:'Suposta infração funcional em atendimento', capitulacao:'Lei 8.112/90 - Art. 116', dataFato:'2025-05-10', dataPrescricao:'2027-05-10', envolvidos:['123.456.789-00'] },
          { descricao:'Descumprimento de prazo processual', capitulacao:'Lei 8.112/90 - Art. 117', dataFato:'2025-06-02', dataPrescricao:'2027-06-02', envolvidos:['987.654.321-00','123.456.789-00'] }
        ],
        andamentos: [
          { descricao:'Instauração', data:'2025-07-15', arquivo:{ nome:'portaria-instauração.pdf', url:'#' } }
        ]
      };
    }

    // ---------- Render ----------
    function renderHeader(){
      const p = state.procedimento;
      $('#proc-numero').textContent = p.numero || '—';
      $('#tag-ramo').textContent = p.ramo || '—';
      $('#tag-sigilo').textContent = p.sigilo ? 'Sigiloso' : 'Não sigiloso';
      const sit = (p.situacao||'').toLowerCase();
      const tag = $('#tag-situacao');
      tag.textContent = sit ? (sit[0].toUpperCase()+sit.slice(1)) : '—';
      tag.classList.remove('status--andamento','status--suspenso','status--finalizado');
      if(sit==='em andamento') tag.classList.add('status--andamento');
      else if(sit==='suspenso') tag.classList.add('status--suspenso');
      else if(sit==='finalizado') tag.classList.add('status--finalizado');
    }

    function kvItem(key,val){
      return `<div class="kv__item"><div class="kv__key">${key}</div><div class="kv__val">${val ?? '—'}</div></div>`;
    }

    function renderDadosBasicos(){
      const p = state.procedimento;
      const el = $('#kv-dados-basicos');
      el.innerHTML = [
        kvItem('Ramo', p.ramo),
        kvItem('Número', p.numero),
        kvItem('Classe', p.classe),
        kvItem('Sigilo', p.sigilo ? 'Ativo' : 'Inativo'),
        kvItem('Data da autuação', formatDate(p.dataAutuacao)),
        kvItem('Situação', p.situacao ? (p.situacao[0].toUpperCase()+p.situacao.slice(1)) : '—'),
        kvItem('Representação/Documento inicial', p.docInicial?.nome ? `<a href="${p.docInicial.url||'#'}" download>Baixar: ${p.docInicial.nome}</a>` : '—')
      ].join('');
    }

    function renderEnvolvidos(){
      const tbody = $('#tbody-envolvidos');
      tbody.innerHTML = '';
      state.procedimento.envolvidos.forEach(e=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(e.nome)}</td><td>${escapeHtml(e.matricula)}</td><td>${escapeHtml(e.cpf)}</td>`;
        tbody.appendChild(tr);
      });
      if(!state.procedimento.envolvidos.length){
        tbody.innerHTML = '<tr><td colspan="3">Nenhum envolvido cadastrado.</td></tr>';
      }
    }

    function renderFatos(){
      const mapCpfNome = new Map(state.procedimento.envolvidos.map(e=>[e.cpf, e.nome]));
      const tbody = $('#tbody-fatos');
      tbody.innerHTML = '';
      state.procedimento.fatos.forEach(f=>{
        const nomes = (f.envolvidos||[]).map(cpf=>`<span class="chip">${escapeHtml(mapCpfNome.get(cpf)||cpf)}</span>`).join(' ');
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(f.descricao||'')}</td>
          <td>${formatDate(f.dataFato)||'—'}</td>
          <td>${formatDate(f.dataPrescricao)||'—'}</td>
          <td>${nomes || '—'}</td>
        `;
        tbody.appendChild(tr);
      });
      if(!state.procedimento.fatos.length){
  tbody.innerHTML = '<tr><td colspan="4">Nenhum fato cadastrado.</td></tr>';
      }
    }

    function renderAndamentos(){
      const tbody = $('#tbody-andamentos');
      tbody.innerHTML = '';
      state.andamentos
        .slice()
        .sort((a,b)=> (b.data||'').localeCompare(a.data||''))
        .forEach((a,idx)=>{
          const tr = document.createElement('tr');
          const link = a.arquivo?.url ? `<a href="${a.arquivo.url}" download>${escapeHtml(a.arquivo.nome)}</a>` : '—';
          tr.innerHTML = `
            <td>${formatDate(a.data)||'—'}</td>
            <td>${escapeHtml(a.descricao||'')}</td>
            <td>${link}</td>
            <td><div class="table__actions">
              <button class="btn btn--muted btn--sm" data-idx="${idx}" data-acao="remover">Remover</button>
            </div></td>
          `;
          tbody.appendChild(tr);
        });
      if(!state.andamentos.length){
        tbody.innerHTML = '<tr><td colspan="4">Nenhum andamento incluído.</td></tr>';
      }
      // ações
      $$('[data-acao="remover"]').forEach(btn=>{
        btn.addEventListener('click', (ev)=>{
          const i = Number(ev.currentTarget.getAttribute('data-idx'));
          // revoga URL do arquivo se houver
          const a = state.andamentos[i];
          if(a?.arquivo?.url && a.arquivo.url.startsWith('blob:')){
            URL.revokeObjectURL(a.arquivo.url);
          }
          state.andamentos.splice(i,1);
          renderAndamentos();
        });
      });
    }

    // ---------- Helpers ----------
    function formatDate(iso){
      if(!iso) return '';
      const [y,m,d] = iso.split('-');
      if(!y||!m||!d) return iso;
      return `${d}/${m}/${y}`;
    }
    function escapeHtml(s){
      return String(s||'').replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]) );
    }

    // ---------- Modal: Andamento ----------
    function limparFormAndamento(){
      $('#and-desc').value = '';
      $('#and-data').value = '';
      $('#and-arquivo').value = '';
  // limpa e oculta campo condicional
  const f = $('#field-nova-classe'); if(f) f.style.display = 'none';
  const s = $('#and-nova-classe'); if(s) s.value = '';
  const f2 = $('#field-data-fim'); if(f2) f2.style.display = 'none';
  const d2 = $('#and-data-fim'); if(d2) d2.value = '';
  const f3 = $('#field-adm-recursal'); if(f3) f3.style.display = 'none';
  $$('input[name="and-adm"]').forEach(el=> el.checked = false);
  const f4 = $('#field-julg-recursal'); if(f4) f4.style.display = 'none';
  $$('input[name="and-julg"]').forEach(el=> el.checked = false);
    }
    function validarAndamento(){
      const desc = $('#and-desc').value.trim();
      const data = $('#and-data').value;
      const file = $('#and-arquivo').files?.[0] || null;
      if(!desc){ alert('Selecione a descrição do andamento.'); return false; }
      if(!data){ alert('Informe a data do movimento.'); return false; }
      if(!file){ alert('Anexe o PDF do andamento.'); return false; }
      if(file.type !== 'application/pdf'){
        alert('O anexo deve ser um arquivo PDF.');
        return false;
      }
      return true;
    }

    function salvarAndamento(){
      const file = $('#and-arquivo').files?.[0] || null;
      const url = file ? URL.createObjectURL(file) : null;
      if(url) state.urlObjects.push(url);
      const novo = {
        descricao: $('#and-desc').value.trim(),
        data: $('#and-data').value,
        arquivo: file ? { nome: file.name, url } : null
      };
      // inclui novaClasse se campo estiver visível e houver valor
      const fieldVisible = $('#field-nova-classe') && getComputedStyle($('#field-nova-classe')).display !== 'none';
      const novaClasseVal = $('#and-nova-classe')?.value?.trim();
      if(fieldVisible && novaClasseVal){
        novo.novaClasse = novaClasseVal;
      }
      // inclui dataFim se campo estiver visível e houver valor
      const fieldFimVisible = $('#field-data-fim') && getComputedStyle($('#field-data-fim')).display !== 'none';
      const dataFimVal = $('#and-data-fim')?.value?.trim();
      if(fieldFimVisible && dataFimVal){
        novo.dataFim = dataFimVal;
      }
      // inclui admissibilidade recursal se campo estiver visível e houver valor
      const fieldAdmVisible = $('#field-adm-recursal') && getComputedStyle($('#field-adm-recursal')).display !== 'none';
      const admVal = document.querySelector('input[name="and-adm"]:checked')?.value;
      if(fieldAdmVisible && admVal){
        novo.admissibilidade = admVal;
      }
      // inclui julgamento recursal se campo estiver visível e houver valor
      const fieldJulgVisible = $('#field-julg-recursal') && getComputedStyle($('#field-julg-recursal')).display !== 'none';
      const julgVal = document.querySelector('input[name="and-julg"]:checked')?.value;
      if(fieldJulgVisible && julgVal){
        novo.julgamentoRecursal = julgVal;
      }
      state.andamentos.push(novo);
      renderAndamentos();
      closeModal('dlg-andamento');
      limparFormAndamento();
    }

    // ---------- Boot ----------
    window.addEventListener('DOMContentLoaded', ()=>{
      // Carrega (mock) procedimento
      state.procedimento = getProcedimentoMock();
      state.andamentos = (state.procedimento.andamentos||[]).slice();

      // Render
      renderHeader();
      renderDadosBasicos();
      renderEnvolvidos();
      renderFatos();
      renderAndamentos();

      // Ações header
      $('#btn-voltar').addEventListener('click', ()=>{
        // preferência: voltar à página anterior; se não houver, vai ao acervo
        if(document.referrer){ history.back(); } else { window.location.href = './acervo.html'; }
      });
      $('#btn-editar').addEventListener('click', ()=>{
        alert('Placeholder: aqui você poderia navegar para uma tela de edição pré-preenchida.');
      });
      $('#btn-novo-andamento').addEventListener('click', ()=> openModal('dlg-andamento'));
      $('#btn-abrir-andamento').addEventListener('click', ()=> openModal('dlg-andamento'));

      // Modal andamento
      $('#btn-fechar-andamento').addEventListener('click', ()=> closeModal('dlg-andamento'));
      $('#btn-cancelar-andamento').addEventListener('click', ()=> closeModal('dlg-andamento'));
      $('#btn-salvar-andamento').addEventListener('click', ()=>{
        if(validarAndamento()) salvarAndamento();
      });

      // Toggle campos condicionais conforme a descrição selecionada
      function toggleConditionalFields(){
        const val = ($('#and-desc').value || '').trim();
        // Nova classe (Instauração / Conversão)
        const showNovaClasse = val === 'Instauração / Conversão';
        const fieldNova = $('#field-nova-classe');
        if(fieldNova){
          fieldNova.style.display = showNovaClasse ? '' : 'none';
          if(!showNovaClasse){ const s = $('#and-nova-classe'); if(s) s.value=''; }
        }
        // Data Fim (Sobrestamento)
        const showDataFim = val === 'Sobrestamento';
        const fieldFim = $('#field-data-fim');
        if(fieldFim){
          fieldFim.style.display = showDataFim ? '' : 'none';
          if(!showDataFim){ const d = $('#and-data-fim'); if(d) d.value=''; }
        }
        // Admissibilidade recursal
        const showAdm = val === 'Admissibilidade recursal';
        const fieldAdm = $('#field-adm-recursal');
        if(fieldAdm){
          fieldAdm.style.display = showAdm ? '' : 'none';
          if(!showAdm){ $$('input[name="and-adm"]').forEach(el=> el.checked=false); }
        }
        // Julgamento recursal
        const showJulg = val === 'Julgamento recursal';
        const fieldJulg = $('#field-julg-recursal');
        if(fieldJulg){
          fieldJulg.style.display = showJulg ? '' : 'none';
          if(!showJulg){ $$('input[name="and-julg"]').forEach(el=> el.checked=false); }
        }
      }
      $('#and-desc').addEventListener('change', toggleConditionalFields);
      // garante estado inicial correto ao abrir a página
      toggleConditionalFields();

      // Limpeza na saída: revoga blob URLs
      window.addEventListener('beforeunload', ()=>{
        state.urlObjects.forEach(u=>{ try{ URL.revokeObjectURL(u); }catch(e){} });
      });
    });
  </script>
</body>
</html>
